

wuxuanyi_sequence = {"ok": 1, "data": [["2018-07-24 20:02:42", 2157492, -1], ["2018-07-24 20:03:47", 2157732, 240], ["2018-07-24 20:04:51", 2158016, 284], ["2018-07-24 20:05:57", 2158244, 228], ["2018-07-24 20:07:00", 2158494, 250], ["2018-07-24 20:08:05", 2158722, 228], ["2018-07-24 20:09:11", 2158990, 268], ["2018-07-24 20:10:14", 2159230, 240], ["2018-07-24 20:11:21", 2159449, 219], ["2018-07-24 20:12:28", 2159708, 259], ["2018-07-24 20:13:32", 2159959, 251], ["2018-07-24 20:14:36", 2160205, 246], ["2018-07-24 20:15:44", 2160425, 220], ["2018-07-24 20:16:47", 2160710, 285], ["2018-07-24 20:17:55", 2160933, 223], ["2018-07-24 20:19:03", 2161243, 310], ["2018-07-24 20:20:06", 2161464, 221], ["2018-07-24 20:21:09", 2161690, 226], ["2018-07-24 20:22:13", 2161921, 231], ["2018-07-24 20:24:20", 2162479, 558], ["2018-07-24 20:25:30", 2162853, 374], ["2018-07-24 20:26:33", 2163113, 260], ["2018-07-24 20:27:38", 2163372, 259], ["2018-07-24 20:28:45", 2163699, 327], ["2018-07-24 20:29:56", 2163956, 257], ["2018-07-24 20:31:01", 2164291, 335], ["2018-07-24 20:32:05", 2164652, 361], ["2018-07-24 20:33:08", 2165021, 369], ["2018-07-24 20:34:13", 2165351, 330], ["2018-07-24 20:35:16", 2165778, 427], ["2018-07-24 20:36:19", 2166088, 310], ["2018-07-24 20:37:22", 2166470, 382], ["2018-07-24 20:38:27", 2166816, 346], ["2018-07-24 20:39:30", 2167198, 382], ["2018-07-24 20:40:34", 2167568, 370], ["2018-07-24 20:41:37", 2167909, 341], ["2018-07-24 20:42:41", 2168282, 373], ["2018-07-24 20:43:44", 2168659, 377], ["2018-07-24 20:44:48", 2169048, 389], ["2018-07-24 20:45:56", 2169364, 316], ["2018-07-24 20:47:01", 2169742, 378], ["2018-07-24 20:48:07", 2170132, 390], ["2018-07-24 20:49:12", 2170518, 386], ["2018-07-24 20:50:15", 2170889, 371], ["2018-07-24 20:51:19", 2171214, 325], ["2018-07-24 20:52:23", 2171570, 356], ["2018-07-24 20:53:26", 2171948, 378], ["2018-07-24 20:54:30", 2172297, 349]], "message": "ok"}

multi_series_inc_data = {"ok": 1, "data": [{"name": "\u5434\u5ba3\u4eea", "list": [["2018-07-25 22:04:48", 2494027, 271], ["2018-07-25 22:05:53", 2494241, 214], ["2018-07-25 22:07:00", 2494489, 248], ["2018-07-25 22:08:04", 2494743, 254], ["2018-07-25 22:09:12", 2494994, 251], ["2018-07-25 22:10:25", 2495241, 247], ["2018-07-25 22:11:33", 2495485, 244], ["2018-07-25 22:12:38", 2495741, 256], ["2018-07-25 22:13:46", 2496009, 268], ["2018-07-25 22:14:52", 2496236, 227], ["2018-07-25 22:15:57", 2496457, 221], ["2018-07-25 22:18:14", 2496943, 486], ["2018-07-25 22:19:23", 2497197, 254], ["2018-07-25 22:22:05", 2497689, 492]], "id": 0}, {"name": "\u5b5f\u7f8e\u5c90", "list": [["2018-07-25 22:04:48", 1154157, 144], ["2018-07-25 22:05:53", 1154221, 64], ["2018-07-25 22:07:00", 1154381, 160], ["2018-07-25 22:08:04", 1154585, 204], ["2018-07-25 22:09:12", 1154793, 208], ["2018-07-25 22:10:25", 1154909, 116], ["2018-07-25 22:11:33", 1155113, 204], ["2018-07-25 22:12:38", 1155237, 124], ["2018-07-25 22:13:46", 1155405, 168], ["2018-07-25 22:14:52", 1155549, 144], ["2018-07-25 22:15:57", 1155789, 240], ["2018-07-25 22:18:14", 1156045, 256], ["2018-07-25 22:19:23", 1156153, 108], ["2018-07-25 22:22:05", 1156577, 424]], "id": 1}, {"name": "Yamy", "list": [["2018-07-25 22:04:48", 1000272, 112], ["2018-07-25 22:05:53", 1000391, 119], ["2018-07-25 22:07:00", 1000475, 84], ["2018-07-25 22:08:04", 1000559, 84], ["2018-07-25 22:09:12", 1000629, 70], ["2018-07-25 22:10:25", 1000741, 112], ["2018-07-25 22:11:33", 1000895, 154], ["2018-07-25 22:12:38", 1001042, 147], ["2018-07-25 22:13:46", 1001133, 91], ["2018-07-25 22:14:52", 1001245, 112], ["2018-07-25 22:15:57", 1001399, 154], ["2018-07-25 22:18:14", 1001868, 469], ["2018-07-25 22:19:23", 1002099, 231], ["2018-07-25 22:22:05", 1002428, 329]], "id": 2}, {"name": "\u5468\u6d01\u743c", "list": [["2018-07-25 22:04:48", 1486422, 200], ["2018-07-25 22:05:53", 1486634, 212], ["2018-07-25 22:07:00", 1486808, 174], ["2018-07-25 22:08:04", 1486972, 164], ["2018-07-25 22:09:12", 1487110, 138], ["2018-07-25 22:10:25", 1487306, 196], ["2018-07-25 22:11:33", 1487530, 224], ["2018-07-25 22:12:38", 1487712, 182], ["2018-07-25 22:13:46", 1487884, 172], ["2018-07-25 22:14:52", 1488048, 164], ["2018-07-25 22:15:57", 1488272, 224], ["2018-07-25 22:18:14", 1488730, 458], ["2018-07-25 22:19:23", 1488932, 202], ["2018-07-25 22:22:05", 1489422, 490]], "id": 3}, {"name": "\u97a0\u5a67\u794e", "list": [["2018-07-25 22:04:48", 450841, 34], ["2018-07-25 22:05:53", 450869, 28], ["2018-07-25 22:07:00", 450893, 24], ["2018-07-25 22:08:04", 450899, 6], ["2018-07-25 22:09:12", 450909, 10], ["2018-07-25 22:10:25", 450947, 38], ["2018-07-25 22:11:33", 450967, 20], ["2018-07-25 22:12:38", 450977, 10], ["2018-07-25 22:13:46", 450991, 14], ["2018-07-25 22:14:52", 451029, 38], ["2018-07-25 22:15:57", 451035, 6], ["2018-07-25 22:18:14", 451091, 56], ["2018-07-25 22:19:23", 451127, 36], ["2018-07-25 22:22:05", 451235, 108]], "id": 4}, {"name": "\u674e\u827a\u5f64", "list": [["2018-07-25 22:04:48", 312404, 0], ["2018-07-25 22:05:53", 312424, 20], ["2018-07-25 22:07:00", 312444, 20], ["2018-07-25 22:08:04", 312448, 4], ["2018-07-25 22:09:12", 312448, 0], ["2018-07-25 22:10:25", 312448, 0], ["2018-07-25 22:11:33", 312492, 44], ["2018-07-25 22:12:38", 312492, 0], ["2018-07-25 22:13:46", 312496, 4], ["2018-07-25 22:14:52", 312516, 20], ["2018-07-25 22:15:57", 312572, 56], ["2018-07-25 22:18:14", 312596, 24], ["2018-07-25 22:19:23", 312604, 8], ["2018-07-25 22:22:05", 312684, 80]], "id": 5}, {"name": "\u4e8e\u6587\u6587", "list": [["2018-07-25 22:04:48", 384968, 0], ["2018-07-25 22:05:53", 384975, 7], ["2018-07-25 22:07:00", 384975, 0], ["2018-07-25 22:08:04", 384975, 0], ["2018-07-25 22:09:12", 384975, 0], ["2018-07-25 22:10:25", 385010, 35], ["2018-07-25 22:11:33", 385045, 35], ["2018-07-25 22:12:38", 385052, 7], ["2018-07-25 22:13:46", 385080, 28], ["2018-07-25 22:14:52", 385080, 0], ["2018-07-25 22:15:57", 385115, 35], ["2018-07-25 22:18:14", 385164, 49], ["2018-07-25 22:19:23", 385164, 0], ["2018-07-25 22:22:05", 385199, 35]], "id": 6}, {"name": "\u9648\u610f\u6db5", "list": [["2018-07-25 22:04:48", 559345, 20], ["2018-07-25 22:05:53", 559357, 12], ["2018-07-25 22:07:00", 559365, 8], ["2018-07-25 22:08:04", 559365, 0], ["2018-07-25 22:09:12", 559365, 0], ["2018-07-25 22:10:25", 559365, 0], ["2018-07-25 22:11:33", 559377, 12], ["2018-07-25 22:12:38", 559377, 0], ["2018-07-25 22:13:46", 559417, 40], ["2018-07-25 22:14:52", 559417, 0], ["2018-07-25 22:15:57", 559417, 0], ["2018-07-25 22:18:14", 559445, 28], ["2018-07-25 22:19:23", 559445, 0], ["2018-07-25 22:22:05", 559445, 0]], "id": 7}, {"name": "\u738b\u83ca", "list": [["2018-07-25 22:04:48", 189233, 39], ["2018-07-25 22:05:53", 189298, 65], ["2018-07-25 22:07:00", 189324, 26], ["2018-07-25 22:08:04", 189337, 13], ["2018-07-25 22:09:12", 189337, 0], ["2018-07-25 22:10:25", 189337, 0], ["2018-07-25 22:11:33", 189337, 0], ["2018-07-25 22:12:38", 189337, 0], ["2018-07-25 22:13:46", 189337, 0], ["2018-07-25 22:14:52", 189337, 0], ["2018-07-25 22:15:57", 189402, 65], ["2018-07-25 22:18:14", 189402, 0], ["2018-07-25 22:19:23", 189402, 0], ["2018-07-25 22:22:05", 189415, 13]], "id": 8}, {"name": "\u82cf\u8bd7\u4e01", "list": [["2018-07-25 22:04:48", 240117, 13], ["2018-07-25 22:05:53", 240130, 13], ["2018-07-25 22:07:00", 240130, 0], ["2018-07-25 22:08:04", 240130, 0], ["2018-07-25 22:09:12", 240156, 26], ["2018-07-25 22:10:25", 240169, 13], ["2018-07-25 22:11:33", 240182, 13], ["2018-07-25 22:12:38", 240182, 0], ["2018-07-25 22:13:46", 240182, 0], ["2018-07-25 22:14:52", 240182, 0], ["2018-07-25 22:15:57", 240234, 52], ["2018-07-25 22:18:14", 240234, 0], ["2018-07-25 22:19:23", 240247, 13], ["2018-07-25 22:22:05", 240247, 0]], "id": 9}], "message": "ok"}

global_name_filter = ['吴宣仪', '孟美岐', 'Yamy', '周洁琼', '鞠婧祎', '李艺彤', '于文文', '陈意涵', '王菊', '苏诗丁'];
// global_name_filter = ['吴宣仪', '孟美岐', 'Yamy', '周洁琼', '鞠婧祎']
global_inc_chart_update_interface = undefined;


function find_singer_from_response_data(name, response_data)
{
    for(var i=0; i<response_data.length; i++)
    {
        var item = response_data[i]
        if(item["name"] == name)
            return item
    }
}

function request_last_minutes(minutes, singer)
{
    var ajax = null;
    if(window.XMLHttpRequest)
        ajax = new XMLHttpRequest()
    else
        ajax = new ActiveXObject("Microsoft.XMLHTTP");

    url = '/last_minutes'
    if(singer && minutes)
        url = url + '?' + 'singer=' + singer + '&minutes=' + minutes
    else if(singer)
        url = url + '?' + 'singer=' + singer
    else if(minutes)
        url = url + '?' + 'minutes=' + minutes

    ajax.open('GET', url)
    ajax.send()

    ajax.onreadystatechange = function(){
        if(ajax.readyState == 4 && ajax.status == 200){
            response_json = JSON.parse(ajax.responseText)
            if(response_json["ok"] > 0 && response_json.data.length > 0)
            {
                console.log('request success')
                // render_vote_data(response_json.data)
                build_inc_chart(response_json.data)
                // build_inc_chart(multi_series_inc_data)

            }
        }
    }
}

function filter_singer_data(singers_data, filter_names_list)
{
    var filtered_data = []
    for(var i=0; i < singers_data.length; ++i)
    {
        var current_name = singers_data[i]["name"]
        if(filter_names_list.indexOf(current_name) > -1)
            filtered_data.push(singers_data[i])
    }

    console.log(filtered_data)
    return filtered_data
}

function build_inc_chart(singers_data, filters)
{
    if(filters)
    {
        singers_data = filter_singer_data(singers_data, filters)
    }

    console.log(singers_data)
    var svg = d3.select("#inc-chart"),
        margin = {top:20, right:80, bottom:30, left:50},
        width = svg.attr("width") - margin.left - margin.right,
        height = svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")")

    var x = d3.scaleTime().range([0, width]),
        y = d3.scaleLinear().range([height, 0]),
        z = d3.scaleOrdinal(d3.schemeCategory10);

    var line = d3.line()
        .curve(d3.curveBasis)
        .x(function(d){ console.log("x", parseTime(d[0]), x(parseTime(d[0]))); return x(parseTime(d[0])); })
        .y(function(d){ console.log("y", d[2]); return y(d[2]); });

    var parseTime = d3.timeParse("%Y-%m-%d %H:%M:%S")
    x.domain(d3.extent(singers_data[0]["list"], function(d) { return parseTime(d[0]); }));   // d3.extent: return the min/max using natural order
    console.log(d3.extent(singers_data[0]["list"], function(d) { return d[0]; }))
    var y_domain_min = d3.min(singers_data, function(singer_item) { return d3.min(singer_item["list"], function(d) { return d[2]; }) });
    var y_domain_max = d3.max(singers_data, function(singer_item) { return d3.max(singer_item["list"], function(d) { return d[2]; }) })
    y.domain([
        y_domain_min,  // min increment
        y_domain_max
    ])
    console.log(y_domain_min)
    console.log(y_domain_max)


    g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));
    g.append("g")
        .attr("class", "axis axis--y")
        .call(d3.axisLeft(y))
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", "0.71em")
        .attr("fill", "#000")
        .text("涨幅/min")

    var singer = g.selectAll(".singer")
        .data(singers_data)
        .enter().append("g")
        .attr("class", "singer")
        .attr("id", function(d){ return "singer-" + d["name"]; })

    singer.append("path")
        .attr("class", "line")
        .attr("d", function(d) { return line(d["list"]); })
        .style("stroke", function(d) { return z(d["id"]); })

    function Update()
    {
        this.add_path = function add_path(singer_item)
        {
            g.append("g")
                .attr("class", "singer")
                .attr("id", "singer-"+singer_item["name"])
                .append("path")
                .attr("class", "line")
                .attr("d", line(singer_item["list"]))
                .style("stroke", z(singer_item["id"]))
        }
        this.delete_path = function delete_path(singer_item)
        {
            var svg = d3.select("#inc-chart");
            svg.select("#singer-" + singer_item["name"]).remove();
        }
    }

    return new Update()
}


function change_name_state_in_fillters(name)
{
    var name_ind = global_name_filter.indexOf(name)
    var singer_item = find_singer_from_response_data(name, multi_series_inc_data.data)
    if(name_ind > -1){
        // exist, delete it
        global_name_filter.splice(name_ind, 1);
        // delete path in d3
        global_inc_chart_update_interface.delete_path(singer_item);
    }else{
        global_name_filter.push(name);
        global_inc_chart_update_interface.add_path(singer_item);
    }
}



function name_checkbox_onchange(event)
{
    change_name_state_in_fillters(event.srcElement.value)
    console.log(global_name_filter)
}

function bind_checkbox_listener()
{
    var checkboxes = document.getElementsByName("display")

    for(var i=0; i<checkboxes.length; i++)
    {
        checkboxes[i].onchange = name_checkbox_onchange

    }
}

window.onload = function()
{
    console.log('onload')

    // request_last_minutes();
    global_inc_chart_update_interface = build_inc_chart(multi_series_inc_data["data"], global_name_filter);
    bind_checkbox_listener()
}